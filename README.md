# TypeScript Compiler & ReasonScript Interop

This project tries to setup interaction between the TypeScript and the Reason compiler.
We use `genType` to generate TS type declarations from ReScript.

## Getting Started

### Installation

```sh
npm install
```

### Building

```sh
npm run re:build && npm run build
```

Native build:

```sh
dune build src/ocaml/read_ast.exe
```

### Continuous Build

```sh
npm run re:watch
```

In another:

```sh
npm run watch
```

### Running

```sh
npm run run src/examples/tree.ts
```

Run native:

```sh
_build/default/src/ocaml/read_ast.exe src/examples/tree.ts.json
```

## Implementation Notes

### atd

The data types and JSON (de-)serializers for asts are generated by [atdgen](https://atd.readthedocs.io/en/latest/atdgen.html).
To re-generate, run:

```sh
cd src/tsast
atdgen -t Ast.atd
atdgen -j Ast.atd
cd ..
atdgen -bs tsast/Ast.atd
```
Note that `@[gentype]` and `@[gentype.opaque]` need to be added manually to `src/tsast/Ast_t.mli` after re-generating.
The same goes for `open Tsast`.

## Setup Notes

- `genType` only generates `.tsx` files ([issue](https://github.com/reason-association/genType/issues/453)).
  We work around this by setting `"jsx": "react"` in `tsconfig.json`.
- `genType` uses `require` ([issue](https://github.com/reason-association/genType/issues/465)).
  This is annoying because it means we cannot use Node's ES6 module mode.
  Workaround: use the `esm` package.
- In Node's ES6 mode, file paths need to carry explicit file type suffixes. TS refuses to generate them.
  One way to fix it is to use `.js` imports in the *original TS file* (like [so](https://github.com/microsoft/TypeScript/issues/41887)).
  The other is to update `tsconfig` like [so](https://github.com/Microsoft/TypeScript/issues/27481#issuecomment-449673378).
  This problem vanishes as soon as we use `esm`.